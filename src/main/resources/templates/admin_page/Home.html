<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Jaundice</title>

    <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
    <link href="https://unpkg.com/bootstrap-table@1.13.3/dist/bootstrap-table.min.css" rel="stylesheet">
    <script src="https://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://unpkg.com/bootstrap-table@1.13.3/dist/bootstrap-table.min.js"></script>
    <script src="https://unpkg.com/bootstrap-table@1.13.4/dist/bootstrap-table-locale-all.min.js"></script>
    <script src="https://unpkg.com/bootstrap-table@1.13.4/dist/extensions/export/bootstrap-table-export.min.js"></script>
    <script src="https://unpkg.com/tableexport.jquery.plugin@1.10.1/tableExport.min.js"></script>

    <link rel="stylesheet" href="/css/bootstrap-datetimepicker.min.css">
    <script src="/js/bootstrap-datetimepicker.min.js"></script>
    <script type="text/javascript" src="/js/bootstrap-datetimepicker.zh-CN.js" charset="UTF-8"></script>
    <script src="/js/echarts.min.js" type="text/javascript" charset="utf-8"></script>

    <title>主页</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
</head>
<body>
<div>
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation" style="margin:0;font-size: 23px;font-family: 华文楷体, serif;">
        <div class="container-fluid">
            <div class="navbar-header" style="margin-right: 40px;">
                <a class="navbar-brand" href="#" style="font-size: 30px;color: rgba(0,0,0,1)">黄疸检测云管理系统</a>
            </div>
            <div>
                <ul class="nav navbar-nav">
                    <li class="active"><a href="#">用户列表</a></li>
                    <li><a href="/data">数据列表</a></li>
                    <li><a href="/statistics">数据统计</a></li>
                </ul>
                <ul class="nav navbar-nav navbar-right">
                    <li class="dropdown">
                        <a id="title-username" class="dropdown-toggle" data-toggle="dropdown" href="#">
                            管理员
                            <span class="caret"></span>
                        </a>
                        <ul class="dropdown-menu" style="font-size: 18px;min-width: 115px;text-align: center;">
                            <li id="logout" style="cursor: pointer"><a>登出</a></li>
                            <li><a href="#">修改密码</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
</div>

<div id="toolbar">
    <button type="button" id="deleteButton" class="btn button" onclick="deleteBaby()" style="color: white">删 除</button>
    <button type="button" id="addButton" class="btn button" onclick="showAddHint()">添 加</button>
</div>

<div class="add_item_bkg"></div>
<div class="add_hint">
    <div class="add_header">
        新增用户
    </div>
    <style>
        .add_content{
            margin-left: 8%;
        }

        .add_input{
            width: 80px;
            height: 15px;
            border-radius: 3px;
            margin-left: 5px;
        }

        .select{
            width: 250px;
            height: 20px;
        }

        .form-wrapper{
            margin-bottom: 10px;
        }

        .form-wrapper .label{
            float: left;
            width: 85px;
            font-size: 16px;
            line-height: 22px;
            text-align: left;
            color: #606266;
            font-weight: 300;
        }

        .add_input{
            border-radius: 4px;
            border: 1px solid #dcdfe6;
            width: 200px;
            height: 27px;
            margin-left: 2%;

        }

        .select-item{
            margin-left: 2%;
            width: 200px;
        }

        .form-control{
            height: 27px;
        }

        .radio-inline{
            margin-left: 20px;
        }
    </style>
    <div class="add_content">
        <!--<input type="text" class="cooperate-input" id="cooperate-email" placeholder="请输入邮箱进行验证">-->
        <div class="form-wrapper">
            <span class="label">手机号码:</span>
            <input type="text" class="add_input" id="add_tel" placeholder="请输入手机号">
        </div>
        <div class="form-wrapper" id="parent">
            <div class="select">
                <span class="label">亲属关系:</span>
                <label class="radio-inline">
                    <input type="radio" name="fatherOrMather" id="optionsRadios1" value="FATHER" checked>父 亲
                </label>
                <label class="radio-inline">
                    <input type="radio" name="fatherOrMather" id="optionsRadios2"  value="MOTHER">母 亲
                </label>
            </div>
        </div>
        <div class="form-wrapper">
            <span class="label">宝宝姓名:</span>
            <input type="text" class="add_input" id="add_baby_name" placeholder="请输入宝宝姓名">
        </div>
        <div class="form-wrapper" id="sex">
            <span class="label">宝宝性别:</span>
            <div class="select">
                <label class="radio-inline">
                    <input type="radio" name="MaleOrFemale" id="optionsRadios3" value="MALE" checked>男
                </label>
                <label class="radio-inline">
                    <input type="radio" name="MaleOrFemale" id="optionsRadios4"  value="FEMALE">女
                </label>
            </div>
        </div>
        <div class="form-wrapper">
            <span class="label">怀孕周数:</span>
            <input type="text" class="add_input" id="add_week" placeholder="请输入孕周">
        </div>
        <div class="form-wrapper" id="blood" style="height: 27px;" >
            <span class="label">血型选择:</span>
            <div class="select-item" style="float: left;">
                <select class="selectpicker form-control" id="select_category" title="请选择..." style="height: 30px;">
                    <!--<option value="0">请选择</option>-->
                    <option value="O">O型</option>
                    <option value="A">A型</option>
                    <option value="B">B型</option>
                    <option value="AB">AB型</option>
                    <option value="OTHER">其他血型</option>
                </select>
            </div>

        </div>
        <div class="form-wrapper" style="margin-bottom: 20px;">
            <span class="label">出生日期:</span>
            <div class="input-group date form_date col-sm-5" data-date="" data-date-format="yyyy年MM月dd日" data-link-field="dtp_input2" data-link-format="yyyy-mm-dd" style="float: left;margin-left: 2%;width: 200px;">
                <input class="form-control" id="birthday" size="16" type="text" value="" readonly style="background-color: white;height: 30px;">
                <span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span>
            </div>
            <input type="hidden" id="dtp_input1" value="" /><br/>

            <script>
                $('.form_date').datetimepicker({
                    language:  'zh-CN',
                    weekStart: 1,
                    todayBtn:  1,
                    autoclose: 1,
                    todayHighlight: 1,
                    startView: 2,
                    minView: 2,
                    forceParse: 0
                });
            </script>
        </div>
        <div class="form-wrapper">
            <span class="label">出生身高:</span>
            <input type="text" class="add_input" id="add_height" placeholder="请输入身高">
        </div>
        <div class="form-wrapper">
            <span class="label">出生体重:</span>
            <input type="text" class="add_input" id="add_weight" placeholder="请输入体重">
        </div>
        <div class="form-wrapper">
            <span class="label">出生地区:</span>
            <input type="text" class="add_input" id="add_area" placeholder="请输入出生地区">
        </div>
        <div class="form-wrapper">
            <span class="label">出生医院:</span>
            <input type="text" class="add_input" id="add_hospital" placeholder="请输入出生医院">
        </div>
    </div>

    <div class="add_buttons" style="margin-bottom: 5px">
        <button class="btn button" id="add_sure" onclick="addSure()">确定</button>
        <button class="btn button" id="add_cancel" onclick="addCancel()">取消</button>
        <span id="error_hint"></span>
    </div>

</div>
<style>

    .add_buttons{
        margin-top: 16px;
        margin-left: 10%;
    }

    .add_item_bkg{
        display: none;
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        opacity: 0.5;
        background: rgb(0, 0, 0);
        z-index: 1002;
    }

    .add_hint{
        display: none;
        z-index: 1003;
        left: 30%;
        top: 20%;
        background-color: white;
        position: absolute;
        width: 40%;
        box-shadow: 0 1px 2px rgba(0,0,0,.5);
        border-radius: 4px;
    }

    .add_header{
        font-size: 18px;
        font-weight: bold;
        padding: 15px;
        color: #333333;
    }

    .button{
        width: 80px;
        background-color: rgba(25,137,250,0.80);
        color: white;
        margin-right: 20px;
    }

    .button:hover{
        background-color: #1989fa;
        color: white;
    }

    .bootstrap-table{
        margin-top: 60px;
        margin-left: auto;
        margin-right: auto;
        width: 95%;
    }
</style>
<table
        id="table"
        data-detail-view="true"
        data-detail-formatter="detailFormatter"
        data-search="true"
        data-trim-on-search="true"
        data-locale="zh-CN"
        data-pagination="true"
        data-show-refresh="true"
        data-show-pagination-switch="true"
        data-sort-class="table-active"
        data-sortable="true"
        data-maintain-selected="true"
        data-toolbar="#toolbar"
>
    <thead>
    <tr>
        <th data-field="state" data-checkbox="true"></th>
        <th data-field="id" data-sortable="true" data-formatter="generateIdPush">手机号</th>
        <th data-field="nickname" data-sortable="true">宝宝名称</th>
        <th data-field="sex" data-sortable="true">宝宝性别</th>
        <th data-field="bornTime" data-sortable="true">出生时间</th>
        <th data-field="area" data-sortable="true">出生城市</th>
        <th data-field="modify" data-sortable="false" data-formatter="generateBtn"></th>
    </tr>
    </thead>
</table>
<div id="change-graph-bg">
    <div id="measure-change" style="width: 800px;height: 450px;"></div>
    <button id="close-chart" class="btn btn-primary" style="float: right">关闭</button>
</div>
<style>
    #change-graph-bg{
        padding: 20px;
        display:none;
        background:white;
        width: 60%;
        z-index: 1010;
        left: 20%;
        top: 20%;
        position: absolute;
        box-shadow: 0 1px 2px rgba(0,0,0,.5);
    }
</style>

<script>
    $("#close-chart").click(function () {
        $(".add_item_bkg").css('display','none');
        $("#change-graph-bg").css('display','none');

    });

    function generateBtn(value ,row) {
        return "<button class='btn' style='background: rgba(25,137,250,0.80);color: white;width: 40%;margin-left: 30%' onclick='modifyInfo("+JSON.stringify(row)+")'>修改信息</button>"
    }
    function generateIdPush(value, row){
        return "<a href='#' id='"+value+"' style='cursor: pointer' onclick='showMeasureChange("+value+")'>"+value+"</a>"
    }
    function showMeasureChange(id) {
        $.ajax({
            url:'/getMeasureByUser',
            type:'POST',
            data:{
                username:id
            },
            success:function (data) {
                generateChangeGraph(data);
            },
            error:function (xml,status,error) {
                console.log(xml+" "+status.state+" "+error)
                alert("服务器连接失败,请重试")
            }
        })
    }
    function generateChangeGraph(data) {
        $(".add_item_bkg").css('display','block');
        $("#change-graph-bg").css('display','block');
        dealDate(data)
        var option={
            title:{
                show:true,
                text:'测量值变化观察曲线'
            },
            tooltip:{
                show:true
            },
            xAxis: {
                type: 'category',
                data: ['2018-10','2018-11','2018-12', '2019-1', '2019-2', '2019-3']
            },
            yAxis: {
                type: 'value'
            },
            series: [{
                data: [100, 200, 260, 370, 440, 490],
                type: 'line',
                smooth:true
            }]
        };
        var peopleRise=echarts.init(document.getElementById('measure-change'));
        peopleRise.setOption(option);
    }
    function dealDate(data) {
        //处理数据，把横坐标和纵坐标分开
        var time=[];
        var lesion=[];
        for (var measure in data){
            time.push(measure.date);
            lesion.push(measure.ice_lesion);
        }
        alert(JSON.stringify(time));
        alert(JSON.stringify(lesion))

    }
    function modifyInfo(data) {
        $(".button").css('color','white');
        $(".add_item_bkg").css('display','block');
        $(".add_hint").css('display','block');
        $(".add_header").html('修改信息');

        $("#add_tel").val(data.id);
        $("#add_baby_name").val(data.nickname);
        $("#add_week").val(data.week);
        $("#add_height").val(data.height);
        $("#add_weight").val(data.weight);
        $("#add_area").val(data.area);
        $("#add_hospital").val(data.hospital);
        if(data.sex==='男'){
            $("#sex input:radio[name='MaleOrFemale'][value='MALE']").attr('checked',true);
        }else{
            $("#sex input:radio[name='MaleOrFemale'][value='FEMALE']").attr('checked',true);
        }

        if(data.parent==='父亲'){
            $("#parent input:radio[name='fatherOrMather'][value='FATHER']").attr('checked',true);
        }else{
            $("#parent input:radio[name='fatherOrMather'][value='MOTHER']").attr('checked',true);
        }
        $("#parent").val(data.parent);
        $("#select_category").val(data.blood);
        $("#birthday").val(data.bornTime);
    }
    function deleteBaby() {
        var ids = $.map($table.bootstrapTable('getSelections'), function (row) {
            return row.id
        });

        if(ids.length===0){
            alert("选择内容不能为空！")
        }else{
            $.ajax({
                type:'POST',
                url:'/deleteUser',
                data:{
                    tel:JSON.stringify(ids)
                },
                success:function (data) {
                    if(data==="SUCCESS"){
                        location.reload();
                    }else{
                        alert("出错了");
                    }
                },
                error:function (data) {
                    alert("出错了");
                }
            })
        }

    }
    function addCancel() {
        $(".add_item_bkg").css('display','none');
        $(".add_hint").css('display','none');
    }
    function addSure() {
        $(".add_item_bkg").css('display','none');
        $(".add_hint").css('display','none');

        var tel=$("#add_tel").val();
        var babyName=$("#add_baby_name").val();
        var week=$("#add_week").val();
        var height=$("#add_height").val();
        var weight=$("#add_weight").val();
        var area=$("#add_area").val();
        var hospital=$("#add_hospital").val();
        var sex=$("#sex input:radio:checked").val();
        var parent=$("#parent input:radio:checked").val();
        var blood=$("#select_category option:checked").val();
        var birthday=$("#birthday").val();

        $.ajax({
            type:'POST',
            url:'/saveNewUser',
            data:{
                tel:tel,
                babyName:babyName,
                week:week,
                height:height,
                weight:weight,
                area:area,
                hospital:hospital,
                parent:parent,
                blood:blood,
                birthday:birthday,
                sex:sex
            },
            success:function (data) {
                if(data==="SUCCESS"){
                    location.reload();
                }else{
                    alert("出错了");
                }
            },
            error:function (data) {
                alert("出错了");
            }
        })
    }
    function showAddHint() {
        $(".button").css('color','white');
        $(".add_item_bkg").css('display','block');
        $(".add_hint").css('display','block');
    }

    var $table=$('#table');
    var $button = $('#deleteButton');
    $(function() {
        $.ajax({
            type:'POST',
            url:'/getUserInfo',
            success:function (data) {
                // alert(JSON.stringify(data));
                $(function () {
                    $table.bootstrapTable({
                        data:data
                    });
                });
            },
            error:function (data) {
                alert("fail");
            }
        });
        /*$button.click(function () {
            var ids = $.map($table.bootstrapTable('getSelections'), function (row) {
                return row.id
            });
            alert(JSON.stringify(ids));
            $table.bootstrapTable('remove', {
                field: 'id',
                values: ids
            })
        })*/
    });

    function convert(key) {
        var name;
        switch (key) {
            case 'id':
                name='手机号';
                break;
            case 'parent':
                name='亲属关系';
                break;
            case 'nickname':
                name='宝宝姓名';
                break;
            case 'sex':
                name='宝宝性别';
                break;
            case 'week':
                name='孕周';
                break;
            case 'blood':
                name='血型';
                break;
            case 'bornTime':
                name='出生时间';
                break;
            case 'height':
                name='出生身高(cm)';
                break;
            case 'weight':
                name='出生体重(kg)';
                break;
            case 'area':
                name='出生地区';
                break;
            case 'hospital':
                name='出生医院';
                break;
            default:
                break;
        }
        return name;
    }
    function detailFormatter(index, row) {
        var html = [];
        var i=1;
        var name;
        $.each(row, function (key, value) {
            if(key==="password"||key==="state"){

            }else{
                name=convert(key);
                // console.log(key+" "+name);
                html.push('<div class="col-xs-3"> <span><b>' + name + ':</b> ' + value + ' </span> </div> ')
                if(i%4===0){
                    html.push('<br>')
                }
                i++;
            }


        });
        return html.join('')
    }
    $("#logout").click(function () {
        localStorage.clear();
        window.location.href='/jaundice';
    });
</script>
</body>
</html>